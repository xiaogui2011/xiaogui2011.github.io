---
layout: post
title: 存储占用
slug: 存储占用
author: ymkNK
date: 2024-05-22 10:39:22 +0800
categories: [云原生, docker]
tags: [磁盘, linux, docker]
img: 1.jpg
---


## 检查分区

/mnt/registry/registry/docker/registry/v2/blobs/sha256

```bash
[root@harbor v2]# du -h --max-depth=1
183M	./repositories
42G	./blobs
42G	.
```

```sh
du -h --max-depth=1  | sort -hr
```

## 清理不必要的文件

目的: 释放一部分空间, 方便登录界面

```
find ./ "*.log" -type f -exec rm {} \;
```

```
find ./ -name "*.tmp" -type f -exec rm {} \;
```

```
find -name "cron.log" -type f -mtime +7 -exec rm {} \;
```

```
find ./ -size +100M -type f
```

## <mark style="background-color:red;">修改data\_volume</mark>

The default data volume

data\_volume: /mnt/registry



## <mark style="color:red;">harbor部署到大磁盘上</mark>

## docker 数据根目录
默认情况下，Docker 将其数据存储在 /var/lib/docker 下

```shell
cat /etc/docker/daemon.json

{
# 假如 /mnt/docker-data是新的挂载点
"data-root": "/mnt/docker-data"
}

systemctl restart docker
```


### 新部署


### 修改现有环境

```shell
sudo systemctl stop docker
sudo mv /var/lib/docker /data/docker
sudo ln -s /data/docker /var/lib/docker
sudo systemctl start docker
```

**案例**
```shell
0 17:10:28 192.168.10.233:/mnt/mydata/kk $ df -h
文件系统               容量  已用  可用 已用% 挂载点
devtmpfs                16G     0   16G    0% /dev
tmpfs                   16G   12K   16G    1% /dev/shm
tmpfs                   16G  1.6G   15G   10% /run
tmpfs                   16G     0   16G    0% /sys/fs/cgroup
/dev/vda1               80G   80G  245M  100% /
/dev/mapper/myvg-mylv  985G   21G  914G    3% /mnt/mydata
tmpfs                  3.2G     0  3.2G    0% /run/user/0
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/6bd1463aa64ed957baa913c70a0e250fa424ef99e10c6c00a9e0185ec414b501/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/4b60780f9adffdc349e9860e3226ba32e9639df040e1906dbad9b4762e8a5d7d/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/7b702c565deb0b517fff7e30945e1e775a08a7c67754bb78a074639fa0ba2a80/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/c0ebf34c9953d2a918469e33e70953348e81db99d253d85e429a5d269a86054a/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/108d488a8b57577df3d9d25ec3dd5c56c960f700019574ece27ec354ed836506/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/88997e086990f8f4add08077b108ac69e88f705e2a88a2161ef0d2a4562c1f16/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/efd91ab7c2c8f8c0381541ee807fee8de23645e4aca9087765bdb2d0a3778317/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/3e46cda2077f25a82fb174a64ef949142c649aca8169d82786632249a2dea196/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/88761124b50dca4ec9e169b438a5ce3c28a023aabfa487d8aa5595c23fbd9f4a/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/121916c52252654e00f16d93507944ed028579b654fdc57834f7cb9347155977/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/984d917c01a9838980084a1031244b91a4e1a6dbe3acca06f6a5127462064bb4/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/c14a7de37c4370533e846d5bce5d04c760ac72c64c4ba69dbd61470adc7b7952/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/b60153e3c8785e9e36e35d7074c9fb2fd8170fa0b7b18a43f05bbf1b8a277054/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/a788a1f62e990963883ee0eac23e6a5f74626df17e8bf7bad97f376523f8225e/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/c7c0865b8eee4787f872f6eaf21e70cc15d03afcb2eeb586eed7da9992a3c3b5/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/1ac5a2ac719ece89af2df87bcd98e3ea9b0ef490024015be574da2c81eeb7230/merged
```
> 原来的环境
{: .prompt-warning }



#### 验证数据迁移
```markdown


从你给出的信息中，我们可以看到 `/dev/vda1` 的 80G 容量已经使用了100%，而磁盘 `/dev/mapper/myvg-mylv` 还有大量的可用空间。下面是将磁盘空间增加到 `/var/lib/docker` 的一种可能的方式。

首先，如果你有一些可以删除的文件或者旧的docker镜像和容器，那么删除它们可以获得一些空间。

其次，你应该在大量的可用磁盘 `/dev/mapper/myvg-mylv` 上创建一个新的目录，例如`/mnt/mydata/docker`。

然后，你可以停止正在运行的Docker守护进程：

```shell
systemctl stop docker
```

接着，将原来的 `/var/lib/docker` 目录下的内容移动到新的目录：

```shell
mv /var/lib/docker/ /mnt/mydata/docker
```

然后，建立符号链接，使得 `/var/lib/docker` 点向新的位置：

```shell
ln -s /mnt/mydata/docker /var/lib/docker
```

最后，你可以重新启动 Docker 守护进程查看效果：

```shell
systemctl start docker
```

如果一切顺利，你应该会在 `/var/lib/docker` 上获得更多的可用空间，而不影响现有的功能。你可以使用 `df -h` 命令确认 Docker 是否已经开始使用新的磁盘空间。

这种方法非常直接，但是要注意，它实际上并没有真正地增加你的 `/` 分区的空间，而只是为Docker提供了更多的存储空间。如果在 `/` 分区上的其他目录需要更多的空间，你可能需要寻找其他的方法来解决你的问题。
```
> harbor的镜像会重新创建, harbor中原来的镜像不受影响
{: .prompt-warning }





## harbor数据根目录

Harbor 的数据安装文件默认在 `/opt/harbor`

Harbor 的数据目录默认在 `/data`

```shell
$ vim /opt/harbor/harbor.yml

# The default data volume
data_volume: /mnt/registry


$ df -h .
文件系统        容量  已用  可用 已用% 挂载点
/dev/vda1        80G   80G  407M  100% /

$ df -h .
文件系统        容量  已用  可用 已用% 挂载点
/dev/vda1        80G   80G  407M  100% /

$ du -h --max-depth=1  | sort -hr
21G	./registry
```

> 也就是说先得有`非系统盘的挂载目录`, 才能修改配置文件
{: .prompt-danger }

### 修改运行中的
```shell
sudo docker-compose -f /path/to/harbor/docker-compose.yml down

# 假设新的路径是 /data/harbor
sudo mkdir -p /data/harbor
sudo mv /your/harbor/data/path/* /data/harbor/

#修改配置文件: data_volume: /data/harbor
vim /opt/harbor/harbor.yml


# 确保 Docker Compose 文件中的数据卷映射与 harbor.yml 中的配置匹配
# 更新 Docker Compose 文件
# volumes:
#  - /data/harbor:/var/lib/harbor
sudo vim /opt/harbor/docker-compose.yml

# 重新启动
sudo docker-compose -f /opt/harbor/docker-compose.yml up -d

# 验证
sudo docker-compose -f /path/to/harbor/docker-compose.yml logs -f
```




### 修改已部署


## 软连接修改

## harbor.yml

data_volume: xxxxxx

> 这里的数据都是干什么的
{: .prompt-danger }



`/opt/harbor/`








## crontab
```shell
0 3 * * * ps -A -ostat,ppid | grep -e '^[Zz]' | awk '{print }' | xargs kill -HUP > /dev/null 2>&1
0 */1 * * * cat /dev/null > /var/log/messages
0 */1 * * * find /var/ -type f -name "*.log" -delete
```
