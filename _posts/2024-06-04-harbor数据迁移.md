---
layout: post
title: docker数据迁移
slug: docker数据迁移
author: ymkNK
date: 2024-06-04 18:10:47 +0800
categories: [云原生, docker]
tags: [磁盘, linux, docker]
img: 1.jpg
---


## 案例
```shell
0 17:10:28 192.168.10.233:/mnt/mydata/kk $ df -h
文件系统               容量  已用  可用 已用% 挂载点
devtmpfs                16G     0   16G    0% /dev
tmpfs                   16G   12K   16G    1% /dev/shm
tmpfs                   16G  1.6G   15G   10% /run
tmpfs                   16G     0   16G    0% /sys/fs/cgroup
/dev/vda1               80G   80G  245M  100% /
/dev/mapper/myvg-mylv  985G   21G  914G    3% /mnt/mydata
tmpfs                  3.2G     0  3.2G    0% /run/user/0
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/6bd1463aa64ed957baa913c70a0e250fa424ef99e10c6c00a9e0185ec414b501/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/4b60780f9adffdc349e9860e3226ba32e9639df040e1906dbad9b4762e8a5d7d/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/7b702c565deb0b517fff7e30945e1e775a08a7c67754bb78a074639fa0ba2a80/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/c0ebf34c9953d2a918469e33e70953348e81db99d253d85e429a5d269a86054a/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/108d488a8b57577df3d9d25ec3dd5c56c960f700019574ece27ec354ed836506/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/88997e086990f8f4add08077b108ac69e88f705e2a88a2161ef0d2a4562c1f16/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/efd91ab7c2c8f8c0381541ee807fee8de23645e4aca9087765bdb2d0a3778317/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/3e46cda2077f25a82fb174a64ef949142c649aca8169d82786632249a2dea196/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/88761124b50dca4ec9e169b438a5ce3c28a023aabfa487d8aa5595c23fbd9f4a/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/121916c52252654e00f16d93507944ed028579b654fdc57834f7cb9347155977/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/984d917c01a9838980084a1031244b91a4e1a6dbe3acca06f6a5127462064bb4/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/c14a7de37c4370533e846d5bce5d04c760ac72c64c4ba69dbd61470adc7b7952/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/b60153e3c8785e9e36e35d7074c9fb2fd8170fa0b7b18a43f05bbf1b8a277054/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/a788a1f62e990963883ee0eac23e6a5f74626df17e8bf7bad97f376523f8225e/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/c7c0865b8eee4787f872f6eaf21e70cc15d03afcb2eeb586eed7da9992a3c3b5/merged
overlay                 80G   80G  245M  100% /var/lib/docker/overlay2/1ac5a2ac719ece89af2df87bcd98e3ea9b0ef490024015be574da2c81eeb7230/merged
```
> 原来的环境
{: .prompt-warning }



## 验证数据迁移

从你给出的信息中，我们可以看到 `/dev/vda1` 的 80G 容量已经使用了100%，而磁盘 `/dev/mapper/myvg-mylv` 还有大量的可用空间。下面是将磁盘空间增加到 `/var/lib/docker` 的一种可能的方式。

首先，如果你有一些可以删除的文件或者旧的docker镜像和容器，那么删除它们可以获得一些空间。

其次，你应该在大量的可用磁盘 `/dev/mapper/myvg-mylv` 上创建一个新的目录，例如`/mnt/mydata/docker`。

然后，你可以停止正在运行的Docker守护进程：

```shell
systemctl stop docker
```

接着，将原来的 `/var/lib/docker` 目录下的内容移动到新的目录：

```shell
mv /var/lib/docker/ /mnt/mydata/docker
```

然后，建立符号链接，使得 `/var/lib/docker` 点向新的位置：

```shell
ln -s /mnt/mydata/docker /var/lib/docker
```

最后，你可以重新启动 Docker 守护进程查看效果：

```shell
systemctl start docker
```

如果一切顺利，你应该会在 `/var/lib/docker` 上获得更多的可用空间，而不影响现有的功能。你可以使用 `df -h` 命令确认 Docker 是否已经开始使用新的磁盘空间。

这种方法非常直接，但是要注意，它实际上并没有真正地增加你的 `/` 分区的空间，而只是为Docker提供了更多的存储空间。如果在 `/` 分区上的其他目录需要更多的空间，你可能需要寻找其他的方法来解决你的问题。

> harbor的镜像会重新创建, harbor中原来的镜像不受影响
{: .prompt-warning }



迁移后的效果
```shell
0 18:02:48 192.168.10.233:/opt/harbor $ df -h
文件系统               容量  已用  可用 已用% 挂载点
devtmpfs                16G     0   16G    0% /dev
tmpfs                   16G   12K   16G    1% /dev/shm
tmpfs                   16G  1.6G   15G   11% /run
tmpfs                   16G     0   16G    0% /sys/fs/cgroup
/dev/vda1               80G   32G   49G   40% /
/dev/mapper/myvg-mylv  985G   72G  863G    8% /mnt/mydata
tmpfs                  3.2G     0  3.2G    0% /run/user/0
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/2711e098d0eb952d8bc34bac1f75fcd3c7ad90272348bb1d7c27f4d318ef3f2d/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/3d4bde88ed210bc796f51bffe199d67f50fed420902aa6428ec48bd789010de8/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/969517abb7e183b58198257cc47c378fd2c441b700cda7d9c14690c5fad61a50/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/3579a8617effa21fbd25e2c682863a757e1cd0efecad5bdd60e14a314c2fc80f/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/734bedc474561df0f031e6020ba7850ed5bdb8bb62a69f2b3c61a03f32dbcb7b/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/82018b7c7276bbf24d24d4a33adc90d9a92c2fcae29bc9a85036f191dfe0c473/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/8e660266865424cd6c68b17c77e828965dd530714d39718c6dcb1474a8d6ec65/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/63078ae5512936f8b1754d8a42635d9972655eb95536bfe4e0559d780c283f1e/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/20aafe257ba68ce5c37f293b50260b535780dd0cf9bbe6526cec50241dda1c2b/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/0e715ceb1033d70b698327594b6b217ce88e71101ad84039379a17153ef44e3f/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/818648a257eb079c364b16e8682f2edd05cbf9d2cf05b0eb7a8a78995a1c106d/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/cdfb7db7d1b62872a7f7cce0c3ceec81096c46b941c9800661d883b98d086455/merged
overlay                 80G   32G   49G   40% /var/lib/docker/overlay2/96a7c82724ddc170ffa72c265a221705bc23fa240d4365ab011a34e10ddf3015/merged
```



