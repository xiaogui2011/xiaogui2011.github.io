---
layout: post
title: kk创建k8s
slug: kk创建k8s
author: ymkNK
date: 2024-05-29 16:59:57 +0800
categories: [云原生,k8s]
tags: [k8s, storageclass, kubekey]
img: 1.jpg
---


## 指定 StorageClass 路径
在 KubeKey 安装过程中指定 StorageClass 路径

创建一个 KubeKey 配置文件

```yaml
apiVersion: kubekey.kubesphere.io/v1alpha2
kind: Cluster
metadata:
  name: sample
spec:
  hosts:
    - {name: master, address: 192.168.0.2, internalAddress: 192.168.0.2, user: root, password: "your_password"}
    - {name: worker, address: 192.168.0.3, internalAddress: 192.168.0.3, user: root, password: "your_password"}
  roleGroups:
    etcd:
      - master
    master:
      - master
    worker:
      - worker
  kubernetes:
    version: v1.23.6
    clusterName: cluster.local
  storage:
    localVolume:
      storageClass:
        isDefaultClass: true
        name: local-path
        hostPaths:
          - path: "/data/k8s-storage" # 指定存储路径
            node: "worker" # 指定节点名称
  network:
    plugin: calico
  registry:
    privateRegistry: ""
```
> 在上面的配置中，通过 hostPaths 字段为 local-path StorageClass 指定了存储路径 /data/k8s-storage，并且该存储路径位于 worker 节点上。

验证 StorageClass
```shell
kubectl get storageclass
```
> 应该能够看到名为 local-path 的 StorageClass，并且它被设置为默认 StorageClass。
{: .prompt-info }



## 自定义 StorageClass
```shell
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: rancher.io/local-path
parameters:
  type: 'local'
  path: '/data/custom-path'  # 指定你的自定义路径
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
```

```shell
kubectl apply -f custom-storageclass.yaml
```

## 配置 NFS 作为默认存储类
使用 KubeKey (kk) 创建 Kubernetes 集群时，可以在配置文件中预定义 NFS 作为默认的存储类。以下是具体步骤，展示如何在使用 KubeKey 部署 Kubernetes 时配置 NFS 作为默认存储类。

确保 NFS 服务器已经设置并正在运行

确保所有 Kubernetes 节点安装了 NFS 客户端：
```shell
sudo apt-get update
sudo apt-get install nfs-common
```

配置文件
```yaml
apiVersion: kubekey.kubesphere.io/v1alpha2
kind: Cluster
metadata:
  name: sample
spec:
  hosts:
  - {name: master, address: 192.168.1.2, internalAddress: 192.168.1.2, user: root, password: "your_password"}
  - {name: worker, address: 192.168.1.3, internalAddress: 192.168.1.3, user: root, password: "your_password"}
  roleGroups:
    etcd:
    - master
    master:
    - master
    worker:
    - worker
  controlPlaneEndpoint:
    domain: lb.kubesphere.local
    address: ""
    port: 6443
  kubernetes:
    version: v1.21.5
  network:
    plugin: calico
  storage:
    defaultStorageClass: nfs-client
    nfs:
      server: <NFS_SERVER_IP>    # 替换为你的 NFS 服务器 IP
      path: /path/to/nfs/share   # 替换为你的 NFS 共享目录
  addons:
  - name: nfs-client-provisioner
    namespace: kube-system
    sources:
      chart:
        name: nfs-subdir-external-provisioner
        repo: https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/
        version: 4.0.14
        values:
          storageClass:
            name: nfs-client
            defaultClass: true
          nfs:
            server: <NFS_SERVER_IP>    # 替换为你的 NFS 服务器 IP
            path: /path/to/nfs/share   # 替换为你的 NFS 共享目录
```

```shell
kk create cluster -f config-sample.yaml
```

测试文件
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-claim
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
```

