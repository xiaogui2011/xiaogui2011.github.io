---
layout: post
title: kk创建k8s
slug: kk创建k8s
author: ymkNK
date: 2024-05-29 16:59:57 +0800
categories: [云原生,k8s]
tags: [k8s, storageclass, kubekey]
img: 1.jpg
---


## 自定义 StorageClass
```shell
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: rancher.io/local-path
parameters:
  type: 'local'
  path: '/data/custom-path'  # 指定你的自定义路径
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
```

```shell
kubectl apply -f custom-storageclass.yaml
```

## 配置 NFS 作为默认存储类
使用 KubeKey (kk) 创建 Kubernetes 集群时，可以在配置文件中预定义 NFS 作为默认的存储类。以下是具体步骤，展示如何在使用 KubeKey 部署 Kubernetes 时配置 NFS 作为默认存储类。

确保 NFS 服务器已经设置并正在运行

确保所有 Kubernetes 节点安装了 NFS 客户端：
```shell
sudo apt-get update
sudo apt-get install nfs-common
```

配置文件
```yaml
apiVersion: kubekey.kubesphere.io/v1alpha2
kind: Cluster
metadata:
  name: sample
spec:
  hosts:
  - {name: master, address: 192.168.1.2, internalAddress: 192.168.1.2, user: root, password: "your_password"}
  - {name: worker, address: 192.168.1.3, internalAddress: 192.168.1.3, user: root, password: "your_password"}
  roleGroups:
    etcd:
    - master
    master:
    - master
    worker:
    - worker
  controlPlaneEndpoint:
    domain: lb.kubesphere.local
    address: ""
    port: 6443
  kubernetes:
    version: v1.21.5
  network:
    plugin: calico
  storage:
    defaultStorageClass: nfs-client
    nfs:
      server: <NFS_SERVER_IP>    # 替换为你的 NFS 服务器 IP
      path: /path/to/nfs/share   # 替换为你的 NFS 共享目录
  addons:
  - name: nfs-client-provisioner
    namespace: kube-system
    sources:
      chart:
        name: nfs-subdir-external-provisioner
        repo: https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/
        version: 4.0.14
        values:
          storageClass:
            name: nfs-client
            defaultClass: true
          nfs:
            server: <NFS_SERVER_IP>    # 替换为你的 NFS 服务器 IP
            path: /path/to/nfs/share   # 替换为你的 NFS 共享目录
```

```shell
kk create cluster -f config-sample.yaml
```

测试文件
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-claim
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
```




## 卸载环境
```shell
./kk delete clusters --cluster -f config-sample.yaml
```

## 指定 StorageClass 路径
在 KubeKey 安装过程中指定 StorageClass 路径

创建一个 KubeKey 配置文件

```yaml
apiVersion: kubekey.kubesphere.io/v1alpha2
kind: Cluster
metadata:
  name: sample
spec:
  hosts:
    - {name: master, address: 192.168.0.2, internalAddress: 192.168.0.2, user: root, password: "your_password"}
    - {name: worker, address: 192.168.0.3, internalAddress: 192.168.0.3, user: root, password: "your_password"}
  roleGroups:
    etcd:
      - master
    master:
      - master
    worker:
      - worker
  kubernetes:
    version: v1.23.6
    clusterName: cluster.local
  storage:
    localVolume:
      storageClass:
        isDefaultClass: true
        name: local-path
        hostPaths:
          - path: "/data/k8s-storage" # 指定存储路径
            node: "worker" # 指定节点名称
  network:
    plugin: calico
  registry:
    privateRegistry: ""
```
> 在上面的配置中，通过 hostPaths 字段为 local-path StorageClass 指定了存储路径 /data/k8s-storage，并且该存储路径位于 worker 节点上。

验证 StorageClass
```shell
kubectl get storageclass
```
> 应该能够看到名为 local-path 的 StorageClass，并且它被设置为默认 StorageClass。
{: .prompt-info }



## 指定runtime是docker还是containerd
```shell

```





## 源集群中导出制品 artifact
[使用 KubeKey 快速离线部署 KubeSphere 集群](https://kubesphere.io/zh/blogs/deploying-kubesphere-clusters-offline-with-kubekey/)

```shell
./kk create manifest

# 源集群中导出制品 artifact
$ export KKZONE=cn
$ ./kk artifact export -m manifest-sample.yaml -o kubesphere.tar.gz
#默认tar包的名字是kubekey-artifact.tar.gz，可通过-o参数自定义包名
```

~~离线环境安装集群~~




## 执行脚本创建 harbor 项目

```shell
$ curl https://github.com/kubesphere/ks-installer/blob/master/scripts/create_project_harbor.sh
$ vim create_project_harbor.sh
# TODO 修改url的值为https://dockerhub.kubekey.local
$ chmod +x create_project_harbor.sh
$ ./create_project_harbor.sh
```

## 使用KK安装镜像仓库

- config-sample.yaml(离线环境集群的配置文件)
- kubesphere.tar.gz（源集群打包出来的 tar 包镜像）
- harbor 安装文件在 /opt/harbor , 如需运维 harbor，可至该目录下。

```shell
$ ./kk init registry -f config-sample.yaml -a kubesphere.tar.gz
```


## 安装kubesphere集群

```shell
$ ./kk create cluster -f config-sample1.yaml -a kubesphere.tar.gz --with-kubernetes v1.21.5 --with-kubesphere v3.2.1 --with-packages
```
> --with-packages（必须添加否则 ios 依赖安装失败）
{: .prompt-warning }



## 查看集群状态
```shell
$ kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath='{.items[0].metadata.name}') -f
```




## 查看需要的资源
```shell
[root@harbor kubesphere]# ls -lt /data/kubesphere/
总用量 13103464
drwxr-xr-x 26 root root        4096 8月  16 2023 kubekey
-rw-r--r--  1 root root        6178 8月  16 2023 config-sample.yaml
-rw-r--r--  1 root root       11616 4月   4 2023 mainfest_b.json
-rw-r--r--  1 root root        5433 4月   3 2023 config-sample.yaml.bak
-rw-r--r--  1 root root   155678720 3月   2 2023 ubuntu-20.04-amd64.iso
-rw-r--r--  1 root root   316667904 3月   2 2023 centos-7-amd64.iso
-rwxr-xr-x  1 root root        1267 2月  23 2023 create_project_harbor.sh
-rw-r--r--  1 root root 12865907909 2月  23 2023 kubesphere.tar.gz
-rwxr-xr-x  1 root root    79648122 2月  23 2023 kk
```













## 修改containerd的数据目录
[参考链接](./2024-06-03-containerd.md)
> sudo vim /etc/containerd/config.toml
{: .prompt-tip }



